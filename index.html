<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leafy Green Lens: AI Lettuce Doctor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .loader {
            border: 4px solid #fdfbf7;
            border-top: 4px solid #b45309; 
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-orange-50 flex items-center justify-center min-h-screen p-4">
    <div class="bg-stone-50 rounded-2xl shadow-lg p-8 max-w-lg w-full text-center">
        <h1 class="text-3xl font-bold text-stone-800 mb-2 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-green-700" viewBox="0 0 20 20" fill="currentColor">
              <path d="M11 3.055a1 1 0 00-2 0V4a1 1 0 002 0V3.055zM14.485 5.515a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM5.515 5.515a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707zM12 10a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zM9 10a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zM7 10a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zM10 18a1 1 0 001-1v-2a1 1 0 10-2 0v2a1 1 0 001 1z" />
            </svg>
            Leafy Green Lens
        </h1>
        <p id="status-text" class="text-stone-600 mb-6">Loading AI model...</p>

        <div id="model-loader-status" class="flex items-center justify-center mb-4">
            <div class="loader"></div>
            <p class="ml-3 text-stone-600">Please wait, this may take a moment.</p>
        </div>
        
        <div class="bg-orange-100 border-2 border-dashed border-amber-800/40 rounded-xl p-8 mb-6 cursor-pointer hover:bg-orange-200/60 transition-colors duration-300 hidden" id="upload-area">
            <input type="file" id="image-upload" class="hidden" accept="image/*">
            <label for="image-upload" class="cursor-pointer">
                <svg class="mx-auto h-12 w-12 text-stone-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <p class="mt-2 text-sm text-stone-500"><span class="font-semibold text-amber-800">Click to upload an image</span></p>
            </label>
        </div>

        <div id="image-preview-container" class="mb-6 hidden">
            <img id="image-preview" src="#" alt="Image preview" class="max-w-full mx-auto rounded-lg shadow-md" style="max-height: 300px;"/>
        </div>

        <button id="predict-button" class="bg-amber-800 text-white font-bold py-3 px-6 rounded-xl w-full hover:bg-amber-900 transition duration-300 ease-in-out disabled:bg-stone-400 disabled:cursor-not-allowed flex items-center justify-center shadow-md hover:shadow-lg" disabled>
            <span id="button-text">Analyze Lettuce Leaf</span>
            <div id="button-loader" class="loader hidden ml-3"></div>
        </button>

        <div id="result-container" class="mt-8 text-left bg-orange-100/50 p-6 rounded-xl hidden border border-stone-200">
            <h2 class="text-xl font-semibold text-stone-800 mb-4">Analysis Result</h2>
            <div class="space-y-3">
                <p class="text-stone-700 text-lg"><strong>Status:</strong> <span id="prediction-status" class="font-bold"></span></p>
                <p class="text-stone-700 text-lg"><strong>Details:</strong> <span id="prediction-details"></span></p>
            </div>
        </div>
    </div>

     <canvas id="canvas" width="224" height="224" class="hidden"></canvas>

    <script>
        const statusText = document.getElementById('status-text');
        const modelLoaderStatus = document.getElementById('model-loader-status');
        const imageUpload = document.getElementById('image-upload');
        const uploadArea = document.getElementById('upload-area');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const predictButton = document.getElementById('predict-button');
        const resultContainer = document.getElementById('result-container');
        const predictionStatus = document.getElementById('prediction-status');
        const predictionDetails = document.getElementById('prediction-details');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        
        let model;

        // This list MUST match the exact order your model was trained on.
        const CLASS_NAMES = [
            'Bacterial',
            'Downy_mildew_on_lettuce',
            'Healthy',
            'Powdery_mildew_on_lettuce',
            'Septoria_blight_on_lettuce',
            'Shepherd_purse_weeds',
            'Viral',
            'Wilt_and_leaf_blight_on_lettuce',
        ];

        async function loadModel() {
            try {
                // This assumes 'lettuce_detector.onnx' is in the same folder as this HTML file.
                model = await ort.InferenceSession.create('./lettuce_detector.onnx');
                console.log("Model loaded successfully.");
                
                modelLoaderStatus.classList.add('hidden');
                uploadArea.classList.remove('hidden');
                statusText.innerText = "Upload an image of a lettuce leaf to classify its health.";

            } catch (err) {
                console.error("Failed to load the model.", err);
                statusText.innerHTML = "<strong>Error:</strong> Could not load the model. <br>Please ensure 'lettuce_detector.onnx' is in the repository and the GitHub Pages site has finished deploying.";
                statusText.classList.add('text-red-600');
                modelLoaderStatus.classList.add('hidden');
            }
        }

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    predictButton.disabled = false;
                    buttonText.innerText = 'Analyze Lettuce Leaf';
                    resultContainer.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        predictButton.addEventListener('click', async () => {
            if (!model) { alert("Model is not loaded yet."); return; }

            buttonText.innerText = 'Analyzing...';
            buttonLoader.classList.remove('hidden');
            predictButton.disabled = true;

            try {
                const preprocessedData = await preprocessImage(imagePreview);
                const inputTensor = new ort.Tensor('float32', preprocessedData, [1, 3, 224, 224]);
                const feeds = { 'input': inputTensor };
                const results = await model.run(feeds);
                const outputTensor = results.output.data;
                displayResults(outputTensor);
            } catch(e) {
                console.error("Error during inference.", e);
                alert("An error occurred during prediction.");
            } finally {
                buttonText.innerText = 'Analyze Lettuce Leaf';
                buttonLoader.classList.add('hidden');
                predictButton.disabled = false;
            }
        });

        // This function perfectly mimics the Python torchvision transforms to ensure accuracy.
        async function preprocessImage(imageElement) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            return new Promise((resolve, reject) => {
                imageElement.onload = () => {
                    try {
                        const shorterEdge = Math.min(imageElement.naturalWidth, imageElement.naturalHeight);
                        const scale = 256 / shorterEdge;
                        const targetWidth = Math.round(imageElement.naturalWidth * scale);
                        const targetHeight = Math.round(imageElement.naturalHeight * scale);

                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = targetWidth;
                        tempCanvas.height = targetHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.drawImage(imageElement, 0, 0, targetWidth, targetHeight);

                        const startX = (targetWidth - 224) / 2;
                        const startY = (targetHeight - 224) / 2;
                        ctx.drawImage(tempCanvas, startX, startY, 224, 224, 0, 0, 224, 224);
                        
                        const imageData = ctx.getImageData(0, 0, 224, 224);
                        const { data } = imageData;
                        const float32Data = new Float32Array(3 * 224 * 224);
                        
                        const mean = [0.485, 0.456, 0.406];
                        const std = [0.229, 0.224, 0.225];

                        for (let i = 0; i < 224 * 224; i++) {
                            float32Data[i] = (data[i * 4] / 255 - mean[0]) / std[0];
                            float32Data[i + 224 * 224] = (data[i * 4 + 1] / 255 - mean[1]) / std[1];
                            float32Data[i + 2 * 224 * 224] = (data[i * 4 + 2] / 255 - mean[2]) / std[2];
                        }
                        resolve(float32Data);
                    } catch (error) { reject(error); }
                };
                imageElement.onerror = reject;
                if (imageElement.complete && imageElement.naturalWidth > 0) {
                    imageElement.onload();
                }
            });
        }
        
        function displayResults(outputTensor) {
            const probabilities = softmax(Array.from(outputTensor));
            const maxIndex = probabilities.indexOf(Math.max(...probabilities));
            const predictedClassName = CLASS_NAMES[maxIndex];

            let status = "Diseased";
            let details = predictedClassName.replace(/_/g, ' ').replace(' on lettuce', '');
            let statusColor = "text-red-700";
            
            if (predictedClassName === 'Healthy') {
                status = "Healthy";
                details = "No disease detected.";
                statusColor = "text-green-700";
            } else if (predictedClassName === 'Shepherd_purse_weeds') {
                status = "Not Lettuce";
                details = "This appears to be a weed (Shepherd's purse).";
                statusColor = "text-amber-800";
            }

            predictionStatus.innerText = status;
            predictionStatus.className = `font-bold ${statusColor}`;
            predictionDetails.innerText = details;
            resultContainer.classList.remove('hidden');
        }

        function softmax(arr) {
            const max = Math.max(...arr);
            const exps = arr.map(x => Math.exp(x - max));
            const sumExps = exps.reduce((a, b) => a + b);
            return exps.map(x => x / sumExps);
        }
        
        loadModel();
    </script>
</body>
</html>

